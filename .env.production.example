# ============================================================================
# Production / Staging Environment Variables
# ============================================================================
# Copy this file to .env and fill in the values.
# DO NOT commit .env to version control!
#
# Usage:
#   cp .env.production.example .env
#   # Edit .env with your values
#   docker-compose --env-file .env up -d

# ============================================================================
# Application Settings
# ============================================================================
# APP_ENV=staging                       # "dev" | "staging" | "prod"
TENANT_ID=investor_01

# Runtime mode — controls which background services start in this process.
# "all"    — everything (dev/single-process only)
# "web"    — HTTP API only (no pollers, no job worker)
# "worker" — DB job processor only (requires JOB_WORKER_ENABLED=true)
# "poller" — Telegram long-polling only (max 1 instance per bot token!)
# See production_runtime_model.md for details.
# RUN_MODE=all

# Background job worker — disabled by default, enable in worker service.
# JOB_WORKER_ENABLED=false

# ============================================================================
# Database
# ============================================================================
# Generate strong password: openssl rand -base64 32
DB_PASSWORD=your-strong-database-password-here
# DATABASE_URL=postgresql://stage0:${DB_PASSWORD}@db:5432/stage0
# EXPECTED_SCHEMA_VERSION=004_add_addr_floor_steps.sql

# ============================================================================
# Channel Provider
# ============================================================================
# Which messaging provider to use for customer conversations.
# "twilio" — Twilio WhatsApp (default)
# "meta"   — Meta WhatsApp Cloud API
# "telegram" — Telegram Bot API
CHANNEL_PROVIDER=twilio

# ============================================================================
# Security
# ============================================================================
# CRITICAL: Generate strong token (32+ characters)
# Generate: python -c "import secrets; print(secrets.token_urlsafe(32))"
ADMIN_TOKEN=your-strong-admin-token-min-32-chars

# Admin Authentication Mode: "bearer", "hmac", or "both"
# ADMIN_AUTH_MODE=both

# Rate limiting
# RATE_LIMIT_PER_MINUTE=60
# CHAT_RATE_LIMIT_PER_MINUTE=10

# Admin host restriction (admin endpoints only accessible on this host)
# ADMIN_HOST=bot-admin.example.com

# Webhook validation (disable only for debugging!)
# REQUIRE_WEBHOOK_VALIDATION=true

# ENABLE_REQUEST_LOGGING=true

# Internal Network Access (for /metrics, /health/detailed when no METRICS_TOKEN)
# Comma-separated CIDR ranges. Default: RFC1918 + localhost.
# INTERNAL_NETWORKS=10.0.0.0/8,172.16.0.0/12,192.168.0.0/16,127.0.0.0/8,::1/128

# SECURITY: Only set to true if behind a trusted reverse proxy (nginx, cloudflared, etc.)
# TRUST_PROXY_HEADERS=false

# ============================================================================
# Media URL Security
# ============================================================================
# TTL for signed /media URLs sent in operator notifications (seconds).
# Telegram/WhatsApp servers must fetch the photo within this window.
# Default: 3600 (1 hour). Increase if notifications are delayed.
# MEDIA_URL_TTL_SECONDS=3600

# ============================================================================
# Twilio (if CHANNEL_PROVIDER=twilio)
# ============================================================================
# Get these from: https://console.twilio.com/
TWILIO_AUTH_TOKEN=your-twilio-auth-token
TWILIO_ACCOUNT_SID=your-twilio-account-sid
TWILIO_PHONE_NUMBER=+1234567890
# Public URL for Twilio signature validation and photo URL generation
TWILIO_WEBHOOK_URL=https://bot.example.com/webhooks/twilio

# ============================================================================
# Meta WhatsApp Cloud API (if CHANNEL_PROVIDER=meta)
# ============================================================================
# META_ACCESS_TOKEN=your-long-lived-access-token
# META_PHONE_NUMBER_ID=123456789012345
# META_WABA_ID=123456789012345
# META_WEBHOOK_VERIFY_TOKEN=your-verify-token
# META_GRAPH_API_VERSION=v20.0
# META_APP_SECRET=your-app-secret

# ============================================================================
# Telegram Channel (if CHANNEL_PROVIDER=telegram)
# ============================================================================
# Get bot token from @BotFather on Telegram.
# If not set, falls back to TELEGRAM_BOT_TOKEN (notification bot).
# TELEGRAM_CHANNEL_BOT_TOKEN=123456789:ABCdefGHIjklMNOpqrsTUVwxyz
# TELEGRAM_CHANNEL_MODE=polling
# Webhook mode only: secret token for validation
# Generate: python -c "import secrets; print(secrets.token_urlsafe(32))"
# TELEGRAM_WEBHOOK_SECRET=your-webhook-secret-token

# ============================================================================
# Operator Notifications
# ============================================================================
# Master switch to disable all notifications
# OPERATOR_NOTIFICATIONS_ENABLED=true

# Channel: "whatsapp" | "telegram" | "email"
# OPERATOR_NOTIFICATION_CHANNEL=whatsapp

# WhatsApp notifications: operator phone number
# OPERATOR_WHATSAPP=+1234567890

# Telegram notifications: bot token + chat/group ID
# TELEGRAM_BOT_TOKEN=123456789:ABCdefGHIjklMNOpqrsTUVwxyz
# TELEGRAM_CHAT_ID=-100123456789

# ============================================================================
# Outbound Message Queue (Twilio rate limit handling)
# ============================================================================
# OUTBOUND_MESSAGES_PER_SECOND=1.0
# OUTBOUND_MAX_RETRIES=3
# OUTBOUND_BASE_RETRY_DELAY=5.0

# ============================================================================
# S3/Bucket Storage (for photos)
# ============================================================================
S3_ENDPOINT_URL=http://minio:9100
S3_ACCESS_KEY=your-access-key
S3_SECRET_KEY=your-secret-key
S3_BUCKET_NAME=stage0
# S3_REGION=auto
# S3_FORCE_PATH_STYLE=true
# Public URL prefix for serving files via CDN (if set, /media redirects here)
# S3_PUBLIC_URL=https://cdn.example.com/bucket

# ============================================================================
# Media Download
# ============================================================================
# Twilio: "http" (default) or "provider_api" (REST API, avoids CDN redirects)
# TWILIO_MEDIA_FETCH_STRATEGY=http
# Meta: "http" (default) or "provider_api" (Graph API fetcher)
# META_MEDIA_FETCH_STRATEGY=http

# Trusted redirect domains (comma-separated suffixes for auth header propagation)
# TRUSTED_REDIRECT_DOMAIN_SUFFIXES=twilio.com,twiliocdn.com,facebook.com,fbsbx.com,fbcdn.net,whatsapp.net
# KEEP_AUTH_ON_TRUSTED_REDIRECTS=true

# ============================================================================
# Image Processing Security
# ============================================================================
# SECURITY: WebP has had critical RCE vulnerabilities (CVE-2023-4863)
# Set to "false" to disable WebP (safer but less compatible)
# ALLOW_WEBP_IMAGES=true
# ALLOW_HEIC_IMAGES=true
# IMAGE_MAX_FILE_SIZE_MB=10
# IMAGE_MAX_PIXELS_MILLIONS=16

# ============================================================================
# Session Management
# ============================================================================
# SESSION_TTL_SECONDS=21600
# SESSION_STALE_HINT_SECONDS=3600

# ============================================================================
# Operator Lead Translation (External API)
# ============================================================================
# Translate final lead payload from user's language to operator's language.
# Only runs on lead finalization — not during dialogue.
# OPERATOR_LEAD_TRANSLATION_ENABLED=false
# OPERATOR_LEAD_TARGET_LANG=ru                  # "ru" | "en" | "he"
# TRANSLATION_PROVIDER=none                     # "none" | "deepl" | "google" | "openai"
# TRANSLATION_API_KEY=                          # Required if provider != none
# TRANSLATION_TIMEOUT_SECONDS=10
# TRANSLATION_RETRIES=2
# TRANSLATION_RATE_LIMIT_PER_MINUTE=60

# ============================================================================
# Dispatch Layer — Iteration 1: Operator Fallback (Manual Copy)
# ============================================================================
# When enabled, operator receives a crew-safe copy-paste message alongside
# the full lead. No PII — only locality, date, volume, floors, items, estimate.
# DISPATCH_CREW_FALLBACK_ENABLED=false

# ============================================================================
# Monitoring
# ============================================================================
# LOG_LEVEL=INFO
# SENTRY_DSN=https://your-sentry-dsn@sentry.io/project-id
# ENABLE_METRICS=true
# Optional: token for /metrics, /health/detailed (if not set, uses internal network check)
# METRICS_TOKEN=your-metrics-token
